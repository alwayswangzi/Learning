# InnoDB的关键特性

InnoDB的关键特性包括：

- 插入缓冲；
- 两次写；
- 自适应哈希索引；
- 异步I/O；
- 刷新临接页。

## 1. 插入缓冲

Insert Buffer是InnoDB最重要的特性之一。Insert Buffer不属于缓冲池的一部分，而是与数据页一样，是物理页的一个组成部分。

### 1.1 为什么要引入插入缓冲机制？

这是由InnoDB引擎B+树的特性决定的。在InnoDB中，主键是行唯一的标识符。索引分为聚集索引和非聚集索引。聚集索引的插入一般是顺序的，不需要磁盘的随机读取。但是对于非聚集索引的叶子节点的插入不不再是顺序的，这是需要离散的访问非聚集索引页，由于随机读取的存在导致了存储性能的下降，所以引入了插入缓冲机制。

### 1.2 插入缓冲是怎样设计的？

Insert Buffer对于非聚集索引的插入不再是每一次直接插入索引页中，而是先判断要插入的非聚集索引页是否在缓冲池中，若在，则直接插入，若不在，则插入到一个insert buffer对象之中，并告诉上层已完成插入操作。然后再以一定的频率和情况进行insert buffer和非聚集索引页的合并（merge）操作，通常将多个插入合并到一个操作之中，提升了插入性能。

### 1.3 使用Insert Buffer需要满足哪些条件？

1. 索引是辅助索引；
2. 索引不是唯一的。

如果索引是唯一的，那么数据库必须要查找索引页来判断插入的唯一性，这时插入缓冲就失去了意义。

### Insert Buffer内部是如何实现的？

数据结构是B+树，InnoDB全局只有一棵Insert Buffer B+树，负责对所有表的辅助索引进行插入缓冲。

## 2. 两次写

Insert Buffer带来的是插入性能上的提升，而double write带来的是数据页可靠性的提升。

### 2.1 为什么要采用两次写机制？

#### 2.1.1 部分写失效问题

有一种情况，当InnoDB正在写入某个页到表中，这时数据库发生了宕机，此时这个页只写了一部分，比如16KB的页只写了4KB，这种情况就是部分写失效。部分写失效会带来数据丢失的问题。

#### 2.1.2可不可以用重做日志进行恢复？

不可以。重做日志是对页的物理操作，如对偏移量0800写一条‘aaaa’记录。如果这个页本身已经发生了损坏，再对其进行重做是没有意义的。

因此，在进行重做之前，需要一个页的副本，当写入失效发生时，先通过页的副本还原该页，在进行从左，这就是double write。

### 2.2 double write的实现机制？

double write分为两个部分：一个在内存里，有一个大小为2MB的double write Buffer 缓存，另一个在磁盘上，有一个大小同样为2MB的连续的共享表空间。

再对缓冲池的脏页进行刷新时，并不直接写磁盘，而是：

1. 通过memcpy将脏页复制到double write buffer
2. 将double write buffer数据一次性写入共享表空间里，在fsync同步磁盘。该操作的写入是连续的。
3. 然后再将double write buffer数据写入对应的各个表文件中，此时的写入操作是离散的。

## 3. 自适应哈希索引

InnoDB引擎会对表上各个索引页进行监控，一旦发现建立哈希索引会对查询带来性能提升，则建立哈希索引，称为自适应哈希索引。

InnoDB引擎会自动根据访问频率和模式自动的对某些热点页建立哈希索引。

## 4. 异步I/O

为了提高磁盘性能，InnoDB和其他数据库系统一样，都采用异步I/O的方式处理磁盘操作。

使用AIO不用用户等待一个I/O操作完成才能进行下一个I/O操作。同时AIO另一个优势就是可以进行I/O Merge操作，提高IOPS性能。

## 5. 刷新邻接页

其工作原理为：当刷新一个脏页时，InnoDB会检测该页所在的区（extent）的所有邻接页，如果是脏页那么就一起刷新。

这样做的好处是：通过AIO可以将多个I/O操作合并成一个I/O操作，这在机械磁盘下有着显著的优势。但同时也带来以下的问题：

- 将不是很脏的也也进行了写入，导致该页之后又变脏了。
- 固态硬盘有着较高的IOPS，是否还需要这个特性？



